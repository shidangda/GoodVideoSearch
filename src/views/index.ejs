<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GoodVideoSearch</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <% const FEATURE_TAGS = ['高颜值', '高身长', '美腿', '温柔可爱', '高冷御姐']; %>
    <main class="page">
      <header class="page__header">
        <div>
          <h1>高热度资源筛选</h1>
          <p class="page__subtitle">
            最近更新：<span><%= lastUpdated %></span>
          </p>
        </div>
        <div class="header-actions">
          <a class="btn btn--ghost" href="/history">历史资源</a>
        </div>
        <form class="filter" method="get">
          <label class="filter__wide">
            数据来源
            <input
              type="url"
              name="searchUrl"
              value="<%= searchUrl %>"
              placeholder="https://www.cilifan.mom/search/666332_1_id.html"
              aria-label="目标列表页地址"
              required
            />
            <small class="filter__hint">默认抓取上述地址，可粘贴任意同类列表页。</small>
          </label>
          <label>
            热度下限
            <input
              type="number"
              min="0"
              name="heat"
              value="<%= heatThreshold %>"
              aria-label="热度下限"
            />
          </label>
          <label>
            起始页
            <input
              type="number"
              min="1"
              name="pageFrom"
              value="<%= typeof pageFrom !== 'undefined' ? pageFrom : 1 %>"
              aria-label="起始页"
            />
          </label>
          <label>
            结束页
            <input
              type="number"
              min="1"
              name="pageTo"
              value="<%= typeof pageTo !== 'undefined' ? pageTo : 1 %>"
              aria-label="结束页"
            />
          </label>
          <button type="submit">刷新</button>
        </form>
      </header>

      <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
      <div class="banner banner--error">
        <strong>请求失败：</strong> <%= errorMessage %>
      </div>
      <% } %>

      <% if (!records.length) { %>
      <section class="empty-state">
        <p>
          在第 <%= typeof pageFrom !== 'undefined' ? pageFrom : 1 %>
          - <%= typeof pageTo !== 'undefined' ? pageTo : 1 %> 页中，
          未找到热度大于 <%= heatThreshold %> 的记录，稍后再试吧。
        </p>
      </section>
      <% } else { %>
      <section class="grid">
        <% records.forEach(function(record) { %>
        <article class="card">
          <header class="card__header">
            <div class="card__badge">#<%= record.order %></div>
            <h2><%= record.title %></h2>
          </header>

          <dl class="card__meta">
            <div>
              <dt>热度</dt>
              <dd><%= record.displayHeat %></dd>
            </div>
            <div>
              <dt>收录时间</dt>
              <dd>
                <div><%= record.displayRecordedAt %></div>
                <small><%= record.relativeTime %></small>
              </dd>
            </div>
            <% if (record.meta?.size) { %>
            <div>
              <dt>大小</dt>
              <dd><%= record.displaySize || '未知' %></dd>
            </div>
            <% } %>
            <% if (record.meta?.type) { %>
            <div>
              <dt>类型</dt>
              <dd><%= record.meta.type %></dd>
            </div>
            <% } %>
          </dl>

          <div class="card__actions">
            <button
              class="btn btn--ghost"
              type="button"
              data-mark-resource
              data-resource-id="<%= record.detailUrl || record.magnet || `record-${record.order}` %>"
              data-title="<%= record.title %>"
              data-magnet="<%= record.magnet || '' %>"
              data-detail-url="<%= record.detailUrl || '' %>"
              data-heat="<%= record.heat || '' %>"
              data-recorded-at="<%= record.isoRecordedAt || '' %>"
              data-size-text="<%= record.rawSize || '' %>"
              data-type-text="<%= record.rawType || '' %>"
            >
              评分
            </button>
            <button
              class="btn btn--ghost btn--hide"
              type="button"
              data-hide-resource
              data-resource-id="<%= record.detailUrl || record.magnet || `record-${record.order}` %>"
              data-title="<%= record.title %>"
              data-magnet="<%= record.magnet || '' %>"
              data-detail-url="<%= record.detailUrl || '' %>"
              data-heat="<%= record.heat || '' %>"
              data-recorded-at="<%= record.isoRecordedAt || '' %>"
              data-size-text="<%= record.rawSize || '' %>"
              data-type-text="<%= record.rawType || '' %>"
            >
              隐藏
            </button>
            <% if (record.magnet) { %>
            <a class="btn" href="<%= record.magnet %>">磁链</a>
            <% } %>
            <a class="btn btn--ghost" href="<%= record.detailUrl %>" target="_blank" rel="noreferrer">
              详情
            </a>
          </div>
        </article>
        <% }); %>
      </section>
      <% } %>
    </main>

    <div id="mark-modal" class="mark-modal" hidden>
      <div class="mark-modal__dialog">
        <button class="mark-modal__close" type="button" data-mark-close>×</button>
        <div class="mark-modal__body">
          <header>
            <p class="mark-modal__subtitle">选择星级和特征标签后，将提示上传封面</p>
            <h2 data-mark-title>资源标题</h2>
          </header>

          <section>
            <h3>评分星级</h3>
            <div class="mark-stars" data-mark-stars>
              <% for (let i = 1; i <= 5; i += 1) { %>
              <button class="mark-stars__item" type="button" data-star="<%= i %>" aria-label="评分 <%= i %> 星">
                ★
              </button>
              <% } %>
            </div>
          </section>

          <section>
            <h3>特征标签</h3>
            <div class="mark-tags">
              <% FEATURE_TAGS.forEach(function(tag) { %>
              <button class="mark-tag" type="button" data-tag="<%= tag %>">
                <span>☆</span>
                <%= tag %>
              </button>
              <% }); %>
            </div>
          </section>

          <section>
            <h3>封面截图</h3>
            <div class="cover-dropzone" data-cover-dropzone>
              <p data-cover-hint>点击或粘贴截图到此处（支持剪贴板）</p>
              <input type="file" accept="image/*" data-cover-input hidden />
              <img data-cover-preview alt="封面预览" hidden />
            </div>
          </section>

          <p class="mark-modal__status" data-mark-status></p>

          <footer class="mark-modal__actions">
            <button type="button" class="btn btn--ghost" data-mark-close>取消</button>
            <button type="button" class="btn" data-mark-save>保存到历史</button>
          </footer>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('mark-modal');

        const starButtons = Array.from(modal.querySelectorAll('[data-star]'));
        const tagButtons = Array.from(modal.querySelectorAll('[data-tag]'));
        const closeButtons = modal.querySelectorAll('[data-mark-close]');
        const saveButton = modal.querySelector('[data-mark-save]');
        const titleEl = modal.querySelector('[data-mark-title]');
        const subtitleEl = modal.querySelector('.mark-modal__subtitle');
        const statusEl = modal.querySelector('[data-mark-status]');
        const dropzone = modal.querySelector('[data-cover-dropzone]');
        const coverInput = modal.querySelector('[data-cover-input]');
        const coverPreview = modal.querySelector('[data-cover-preview]');
        const coverHint = modal.querySelector('[data-cover-hint]');
        const starSection = modal.querySelector('[data-mark-stars]')?.closest('section');
        const tagSection = modal.querySelector('.mark-tags')?.closest('section');
        const coverSection = modal.querySelector('[data-cover-dropzone]')?.closest('section');
        const footerEl = modal.querySelector('.mark-modal__actions');

        const ACTIVE_CLASS = 'is-active';
        const TAG_ACTIVE_CLASS = 'is-selected';

        let currentRecord = null;
        let currentRating = 0;
        let selectedTags = new Set();
        let coverFile = null;
        let currentCard = null;
        let currentMarkButton = null; // 保存当前触发标记的按钮
        let isCoverOnlyMode = false;

        document.addEventListener('click', (event) => {
          // 点击评分按钮
          const markTrigger = event.target.closest('[data-mark-resource]');
          if (markTrigger) {
            currentMarkButton = markTrigger;
            currentCard = markTrigger.closest('.card');
            openModal({
              resourceId: markTrigger.dataset.resourceId,
              title: markTrigger.dataset.title,
              magnet: markTrigger.dataset.magnet,
              detailUrl: markTrigger.dataset.detailUrl,
              heat: markTrigger.dataset.heat,
              recordedAt: markTrigger.dataset.recordedAt,
              sizeText: markTrigger.dataset.sizeText,
              typeText: markTrigger.dataset.typeText,
            });
            return;
          }

          // 隐藏卡片
          const hideTrigger = event.target.closest('[data-hide-resource]');
          if (hideTrigger) {
            handleHideResource(hideTrigger);
            return;
          }
        });

        starButtons.forEach((btn) => {
          btn.addEventListener('click', () => {
            setRating(Number(btn.dataset.star));
            checkReadyForCover(); // 检查是否可以选择封面
          });
        });

        tagButtons.forEach((btn) => {
          btn.addEventListener('click', () => {
            const tag = btn.dataset.tag;
            if (!tag) return;
            if (selectedTags.has(tag)) {
              selectedTags.delete(tag);
              btn.classList.remove(TAG_ACTIVE_CLASS);
            } else {
              selectedTags.add(tag);
              btn.classList.add(TAG_ACTIVE_CLASS);
            }
            checkReadyForCover(); // 检查是否可以选择封面
          });
        });

        closeButtons.forEach((btn) => {
          btn.addEventListener('click', closeModal);
        });

        saveButton.addEventListener('click', async () => {
          if (!currentRecord) {
            setStatus('资源信息缺失，请刷新页面');
            return;
          }
          if (!currentRating) {
            setStatus('请先选择星级评分');
            return;
          }
          if (!coverFile) {
            setStatus('请粘贴或上传封面截图');
            return;
          }

          const formData = new FormData();
          Object.entries(currentRecord).forEach(([key, value]) => {
            if (typeof value !== 'undefined' && value !== null) {
              formData.append(key, value);
            }
          });
          formData.append('rating', currentRating);
          formData.append('tags', JSON.stringify(Array.from(selectedTags)));
          formData.append('cover', coverFile);

          setStatus('保存中，请稍候...', true);

          try {
            const response = await fetch('/history', {
              method: 'POST',
              body: formData,
            });
            if (!response.ok) {
              const payload = await response.json().catch(() => ({}));
              throw new Error(payload.message || '保存失败');
            }
            setStatus('保存成功！', true);
            setTimeout(() => {
              closeModal();
              // 隐藏对应的卡片
              const card = currentCard || (currentMarkButton && currentMarkButton.closest('.card'));
              if (card) {
                card.style.transition = 'opacity 0.3s, transform 0.3s';
                card.style.opacity = '0';
                card.style.transform = 'scale(0.95)';
                setTimeout(() => {
                  card.remove();
                }, 300);
              }
            }, 800);
          } catch (error) {
            setStatus(error.message || '保存失败');
          }
        });

        dropzone.addEventListener('click', () => coverInput.click());
        dropzone.addEventListener('paste', handlePaste);
        modal.addEventListener('paste', handlePaste);
        coverInput.addEventListener('change', () => {
          const [file] = coverInput.files || [];
          if (file) {
            setCoverFile(file);
          }
        });

        function openModal(record) {
          currentRecord = record;
          currentRating = 0;
          selectedTags.clear();
          coverFile = null;
          coverPreview.hidden = true;
          coverPreview.removeAttribute('src');
          coverInput.value = '';
          setStatus('');
          titleEl.textContent = record.title || '未知资源';
          modal.removeAttribute('hidden');
          document.body.style.overflow = 'hidden';
          coverHint.textContent = '点击或粘贴截图到此处（支持剪贴板）';
          setRating(0);
          tagButtons.forEach((btn) => btn.classList.remove(TAG_ACTIVE_CLASS));
          setCoverOnlyMode(false); // 显示完整的评分界面
        }

        function checkReadyForCover() {
          // 如果已选择星级和至少一个标签，自动切换到封面上传模式
          if (currentRating > 0 && selectedTags.size > 0) {
            setCoverOnlyMode(true);
            setStatus('请上传封面截图', false);
          } else {
            setCoverOnlyMode(false);
            setStatus('');
          }
        }

        function setCoverOnlyMode(flag) {
          isCoverOnlyMode = !!flag;
          if (starSection) starSection.style.display = flag ? 'none' : '';
          if (tagSection) tagSection.style.display = flag ? 'none' : '';
          if (coverSection) coverSection.style.display = '';
          if (subtitleEl) subtitleEl.textContent = flag ? '请上传封面截图（支持粘贴或上传）' : '亮星星 + 选择特征标签 + 上传封面';
          if (footerEl) footerEl.style.display = '';
        }

        function closeModal() {
          modal.setAttribute('hidden', 'true');
          document.body.style.overflow = '';
          currentRecord = null;
          currentMarkButton = null; // 清除按钮引用
          setCoverOnlyMode(false);
        }

        function setRating(value) {
          currentRating = value;
          starButtons.forEach((btn) => {
            const starValue = Number(btn.dataset.star);
            if (starValue <= value) {
              btn.classList.add(ACTIVE_CLASS);
            } else {
              btn.classList.remove(ACTIVE_CLASS);
            }
          });
        }

        function setCoverFile(file) {
          if (!file || !file.type.startsWith('image/')) {
            setStatus('请粘贴或上传图片文件');
            return;
          }
          coverFile = file;
          const reader = new FileReader();
          reader.onload = () => {
            coverPreview.src = reader.result;
            coverPreview.hidden = false;
            coverHint.textContent = '已加载封面，可重新粘贴覆盖';
          };
          reader.readAsDataURL(file);

          // 封面已就绪，若为只上传封面模式则自动保存
          if (isCoverOnlyMode && currentRating > 0 && selectedTags.size > 0) {
            // 延迟一下让用户看到预览，然后自动保存
            setTimeout(() => {
              saveButton.click();
            }, 500);
          }
        }

        function handlePaste(event) {
          const items = event.clipboardData?.items;
          if (!items) return;
          for (const item of items) {
            if (item.type.startsWith('image/')) {
              const blob = item.getAsFile();
              if (blob) {
                const file = new File([blob], `cover-${Date.now()}.png`, {
                  type: blob.type || 'image/png',
                });
                setCoverFile(file);
                event.preventDefault();
                return;
              }
            }
          }
        }

        function setStatus(message, success = false) {
          statusEl.textContent = message;
          statusEl.classList.toggle('is-success', success);
        }

        async function handleHideResource(button) {
          const card = button.closest('.card');
          if (!card) return;

          const resourceId = button.dataset.resourceId;
          const title = button.dataset.title;
          const magnet = button.dataset.magnet || '';
          const detailUrl = button.dataset.detailUrl || '';
          const heat = button.dataset.heat || '';
          const recordedAt = button.dataset.recordedAt || '';
          const sizeText = button.dataset.sizeText || '';
          const typeText = button.dataset.typeText || '';

          button.disabled = true;
          button.textContent = '隐藏中...';

          try {
            const response = await fetch('/hide-resource', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                resourceId,
                title,
                magnet,
                detailUrl,
                heat,
                recordedAt,
                sizeText,
                typeText,
              }),
            });

            if (!response.ok) {
              const data = await response.json();
              throw new Error(data.message || '隐藏失败');
            }

            // 隐藏卡片
            card.style.transition = 'opacity 0.3s, transform 0.3s';
            card.style.opacity = '0';
            card.style.transform = 'scale(0.95)';
            setTimeout(() => {
              card.remove();
            }, 300);
          } catch (error) {
            button.disabled = false;
            button.textContent = '不再显示';
            alert('隐藏失败: ' + error.message);
          }
        }
      });
    </script>
  </body>
</html>

