# 安装脚本完整性检查清单

## ✅ 已确认的组件和功能

### 1. 系统环境准备
- ✅ 环境检查（操作系统版本、root 权限）
- ✅ 系统软件包更新
- ✅ 基础工具安装（curl, wget, git 等）

### 2. 软件安装
- ✅ Node.js 18+ 安装（使用 NodeSource）
- ✅ npm 镜像配置（智能检测，支持腾讯云内网镜像）
- ✅ MySQL 数据库服务器安装
- ✅ Nginx Web 服务器安装
- ✅ PM2 进程管理器安装和开机自启配置

### 3. 项目部署
- ✅ 从 Git 仓库克隆项目
- ✅ 安装项目依赖（npm install --production）
- ✅ 创建必要的目录（data/covers, logs）

### 4. 数据库配置
- ✅ 创建数据库（goodvideo_archive）
- ✅ 创建数据库用户（goodvideo_user）
- ✅ 授予权限
- ✅ 创建数据表：
  - ✅ history_records（历史记录表）
  - ✅ history_common_records（通用历史记录表）
- ✅ 表结构包含索引优化

### 5. 环境变量配置
- ✅ 创建 .env 文件
- ✅ 配置数据库连接信息（DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD）
- ✅ 配置应用端口（PORT）
- ✅ 文件权限设置（600，仅所有者可读写）

### 6. 应用启动配置
- ✅ PM2 配置文件（ecosystem.config.js）
- ✅ PM2 支持加载 .env 文件（env_file 配置）
- ✅ 日志配置（logs/err.log, logs/out.log）
- ✅ 自动重启配置
- ✅ 内存限制配置（500MB）

### 7. Web 服务器配置
- ✅ Nginx 反向代理配置
- ✅ 静态文件缓存优化
- ✅ 文件上传大小限制（10MB）
- ✅ 真实 IP 传递配置
- ✅ WebSocket 支持

### 8. 安全配置
- ✅ 防火墙规则配置（UFW）
- ✅ SSH 端口保护
- ✅ HTTP/HTTPS 端口开放

### 9. 应用启动
- ✅ 使用 PM2 启动应用
- ✅ 环境变量自动加载
- ✅ 应用状态验证
- ✅ PM2 配置保存

## 📋 脚本执行流程（13 步）

1. ✅ **环境检查** - 检查操作系统和权限
2. ✅ **系统更新** - 更新软件包列表和系统
3. ✅ **安装 Node.js** - 安装 Node.js 18+ 和 npm
4. ✅ **安装 MySQL** - 安装并启动 MySQL 服务
5. ✅ **安装 Nginx** - 安装并启动 Nginx 服务
6. ✅ **安装 PM2** - 安装 PM2 并配置开机自启
7. ✅ **克隆项目** - 从 Git 仓库克隆项目
8. ✅ **安装依赖** - 安装项目 npm 依赖
9. ✅ **配置数据库** - 创建数据库和用户
10. ✅ **创建环境变量** - 创建 .env 配置文件
11. ✅ **创建数据表** - 创建项目所需的数据表
12. ✅ **配置 Nginx** - 配置反向代理
13. ✅ **配置防火墙** - 开放必要端口
14. ✅ **启动应用** - 使用 PM2 启动应用

## 🔍 关键配置检查

### 环境变量（.env 文件）
```env
DB_HOST=127.0.0.1          ✅
DB_PORT=3306               ✅
DB_NAME=goodvideo_archive  ✅
DB_USER=goodvideo_user    ✅
DB_PASSWORD=用户输入       ✅
PORT=3000                  ✅
```

### PM2 配置（ecosystem.config.js）
- ✅ env_file: '.env' - 自动加载环境变量
- ✅ 日志文件配置
- ✅ 自动重启配置
- ✅ 内存限制配置

### 数据库表结构
- ✅ history_records - 包含所有必要字段和索引
- ✅ history_common_records - 包含所有必要字段和索引

### Nginx 配置
- ✅ 反向代理到 localhost:3000
- ✅ 文件上传大小限制
- ✅ 静态文件缓存
- ✅ 真实 IP 传递

## ⚠️ 需要注意的事项

### 1. MySQL Root 密码
- 脚本会尝试多种方式连接 MySQL：
  - 无密码连接（MySQL 8.0+ auth_socket）
  - 临时密码连接
  - sudo mysql 连接
- 如果都失败，会提示手动执行 SQL

### 2. 环境变量加载
- PM2 5.1+ 支持 `env_file` 配置，自动加载 .env
- 如果 PM2 版本较旧，脚本会使用 `export` 方式加载

### 3. 用户权限
- 脚本使用 `$SUDO_USER` 确保文件所有者正确
- PM2 以普通用户身份运行，更安全

### 4. 端口配置
- 默认应用端口：3000
- 默认数据库端口：3306
- 防火墙开放：22 (SSH), 80 (HTTP), 443 (HTTPS)

## 🚀 脚本可以直接运行

**结论：脚本已经完整，可以直接在云服务器上运行！**

### 运行前准备
1. ✅ 确保服务器是 Ubuntu 20.04（或其他 Ubuntu 版本）
2. ✅ 确保有 root 权限（使用 sudo）
3. ✅ 确保可以访问互联网（下载软件包和 Git 仓库）

### 运行方式
```bash
chmod +x install.sh
sudo ./install.sh
```

### 交互式输入
脚本会询问以下信息：
1. 确认安装（y/n）
2. npm 镜像配置（y/n，腾讯云用户建议选 n）
3. 数据库密码（需要输入两次确认）
4. 应用端口（默认 3000，可直接回车）
5. 域名或 IP（可直接回车使用服务器 IP）
6. 防火墙启用（y/n，建议选 y）

### 安装后验证
```bash
# 检查应用状态
pm2 status

# 查看应用日志
pm2 logs goodvideosearch

# 访问应用
curl http://localhost:3000
# 或通过浏览器访问服务器 IP
```

## 📝 总结

✅ **所有必要的组件都已包含**
✅ **所有配置都已自动化**
✅ **环境变量会自动加载**
✅ **数据库表会自动创建**
✅ **应用会自动启动**
✅ **可以直接从 0 开始运行**

脚本已经完整，可以直接使用！


